(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[106],{1844:e=>{e.exports={chatPageContainer:"Chat_chatPageContainer__kJbSh",sidebar:"Chat_sidebar__tnhH_",sidebarHeader:"Chat_sidebarHeader____yl0",searchContainer:"Chat_searchContainer__ldd07",searchIcon:"Chat_searchIcon__Op28U",searchInput:"Chat_searchInput__VA4nh",connectionsList:"Chat_connectionsList__GLqsC",listInfo:"Chat_listInfo__vIz_F",connectionItem:"Chat_connectionItem__O_fBp",active:"Chat_active__c_57t",avatarContainer:"Chat_avatarContainer__GWjEP",avatar:"Chat_avatar__Tt1Hh",onlineIndicator:"Chat_onlineIndicator__2YHb6",connectionInfo:"Chat_connectionInfo__3sWZk",lastMessage:"Chat_lastMessage__hhSac",connectionMeta:"Chat_connectionMeta__DQnr3",lastMessageTime:"Chat_lastMessageTime__H1RGW",unreadBadge:"Chat_unreadBadge__Eau8D",chatArea:"Chat_chatArea___WXRP",chatHeader:"Chat_chatHeader__4WeFi",chatHeaderInfo:"Chat_chatHeaderInfo__P65oW",onlineIndicatorHeader:"Chat_onlineIndicatorHeader___I4QN",userStatus:"Chat_userStatus__3DBrm",roleBadge:"Chat_roleBadge__nY5cj",chatHeaderActions:"Chat_chatHeaderActions__Wo_g_",iconButton:"Chat_iconButton___bZ5D",messagesContainer:"Chat_messagesContainer__p2PwH",messageWrapper:"Chat_messageWrapper__w6pzj",sent:"Chat_sent__u61Ro",received:"Chat_received__fnz3g",messageContent:"Chat_messageContent__N9VFX",messageInfo:"Chat_messageInfo__Il8B_",timestamp:"Chat_timestamp__QpvKQ",messageStatus:"Chat_messageStatus__Kg_Dw",read:"Chat_read__sXC0M",sending:"Chat_sending___T0Ds",errorIndicator:"Chat_errorIndicator__gT8yF",attachment:"Chat_attachment__VwY0a",attachmentImage:"Chat_attachmentImage__IH2fk",attachmentLink:"Chat_attachmentLink__FfbN0",dateDivider:"Chat_dateDivider__8Uxfp",inputContainer:"Chat_inputContainer__EEHnl",messageInput:"Chat_messageInput__7Wkkk",sendButton:"Chat_sendButton__tZ_K8",noChatSelected:"Chat_noChatSelected__bc_D8",noMessages:"Chat_noMessages__DlqL0",typingIndicator:"Chat_typingIndicator__PgPaF",loadingContainer:"Chat_loadingContainer__Ho6ai",errorContainer:"Chat_errorContainer__fBhAH",loadingMessages:"Chat_loadingMessages__g_aLV",errorContainerInline:"Chat_errorContainerInline__LbkUS",spinner:"Chat_spinner__eKiah",spin:"Chat_spin__xMNso",retryButton:"Chat_retryButton__Lmcm7",retryButtonSmall:"Chat_retryButtonSmall__Pp4JW",backButton:"Chat_backButton__ayA2c",visible:"Chat_visible__O65w0",statusIcon:"Chat_statusIcon__wVS5m",delivered:"Chat_delivered__70Sas"}},2334:(e,a,t)=>{"use strict";t.r(a),t.d(a,{default:()=>b});var n=t(7876),s=t(4232),i=t(2934),r=t(4e3),c=t(235),o=t(1622),l=t(1841),d=t(2724),h=t(3276),_=t(2457),m=t(9516),u=t(2885),g=t(1020),v=t(1268),C=t(9544),p=t(26),j=t(7396),x=t(1844),N=t.n(x);let f=e=>{let a=new Date(e);return(0,c.c)(a)?(0,o.GP)(a,"HH:mm"):(0,l.P)(a)?"Yesterday ".concat((0,o.GP)(a,"HH:mm")):(0,o.GP)(a,"dd/MM/yy HH:mm")},I=e=>{if(!e)return"";let a=new Date(e);return(0,c.c)(a)?(0,o.GP)(a,"HH:mm"):(0,l.P)(a)?"Yesterday":(0,o.GP)(a,"dd/MM/yy")};function b(){var e;let{data:a,status:t}=(0,i.useSession)(),c=(0,r.useRouter)(),[l,x]=(0,s.useState)([]),[b,w]=(0,s.useState)(null),[y,S]=(0,s.useState)([]),[M,H]=(0,s.useState)(""),[A,k]=(0,s.useState)(!0),[B,D]=(0,s.useState)(!1),[P,E]=(0,s.useState)(null),[L,O]=(0,s.useState)(""),[W,z]=(0,s.useState)(!0),T=(0,s.useRef)(null),F=(0,s.useRef)(null);(0,s.useEffect)(()=>{"unauthenticated"===t?c.push("/auth/login"):"authenticated"===t&&R()},[t,c]),(0,s.useEffect)(()=>{(null==b?void 0:b._id)?(G(b._id),window.innerWidth<=768&&z(!1)):S([])},[b]),(0,s.useEffect)(()=>{X()},[y]);let R=async()=>{k(!0),E(null);try{let e=await fetch("/api/chat/connections");if(!e.ok)throw Error((await e.json()).message||"Failed to fetch connections");let a=(await e.json()).map(e=>({...e,lastMessageTimestamp:e.lastMessageTimestamp||new Date(Date.now()-432e6*Math.random()).toISOString(),isOnline:void 0===e.isOnline?Math.random()>.5:e.isOnline,role:e.role||(Math.random()>.6?"Alumni":"Student")}));x(a)}catch(e){console.error("Error fetching connections:",e),E(e.message)}finally{k(!1)}},G=async e=>{D(!0),E(null);try{let t=await fetch("/api/chat/messages/".concat(e));if(!t.ok)throw Error((await t.json()).message||"Failed to fetch messages");let n=await t.json(),s=n.map((e,t)=>{var s,i;return{...e,sender:e.sender||(t%2==0?null==a?void 0:null===(s=a.user)||void 0===s?void 0:s.id:null==b?void 0:b._id),read:void 0===e.read?e.sender===(null==a?void 0:null===(i=a.user)||void 0===i?void 0:i.id)?Math.random()>.3:void 0:e.read,createdAt:e.createdAt||new Date(Date.now()-36e5*Math.random()*(n.length-t)).toISOString()}});S(s)}catch(e){console.error("Error fetching messages:",e),E(e.message)}finally{D(!1)}},U=async e=>{var t;if(e.preventDefault(),!M.trim()||!b||!(null==a?void 0:null===(t=a.user)||void 0===t?void 0:t.id))return;let n="temp-".concat(Date.now()),s={_id:n,content:M,sender:a.user.id,receiver:b._id,createdAt:new Date().toISOString(),status:"sending",read:!1};S(e=>[...e,s]),H(""),X();try{let e=await fetch("/api/chat/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:s.content,receiver:s.receiver})});if(!e.ok)throw Error((await e.json()).message||"Failed to send message");let a=await e.json();S(e=>e.map(e=>e._id===n?{...a,status:"sent"}:e))}catch(e){console.error("Error sending message:",e),E("Failed to send: ".concat(e.message)),S(e=>e.map(e=>e._id===n?{...e,status:"failed"}:e))}},V=e=>{(null==b?void 0:b._id)!==e._id&&w(e),window.innerWidth<=768&&z(!1)},X=()=>{var e;null===(e=T.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})};if("loading"===t||"authenticated"===t&&A&&0===l.length)return(0,n.jsxs)("div",{className:N().loadingContainer,children:[(0,n.jsx)("div",{className:N().spinner}),(0,n.jsx)("p",{children:"Loading your chats..."})]});if(P&&!b&&0===l.length)return(0,n.jsxs)("div",{className:N().errorContainer,children:[(0,n.jsxs)("p",{children:["Error loading connections: ",P]}),(0,n.jsx)("button",{className:N().retryButton,onClick:R,children:"Retry"})]});let Y=l.filter(e=>{var a;return null===(a=e.name)||void 0===a?void 0:a.toLowerCase().includes(L.toLowerCase())}),K=e=>"sending"===e.status?(0,n.jsx)(h.A,{size:16,className:"".concat(N().statusIcon," ").concat(N().sending)}):"failed"===e.status?(0,n.jsx)("span",{className:N().errorIndicator,children:"!"}):e.read?(0,n.jsx)(_.A,{size:16,className:"".concat(N().statusIcon," ").concat(N().read)}):"sent"===e.status||e.delivered?(0,n.jsx)(h.A,{size:16,className:"".concat(N().statusIcon," ").concat(N().delivered)}):null;return(0,n.jsxs)("div",{className:N().chatPageContainer,children:[(0,n.jsxs)("aside",{className:"".concat(N().sidebar," ").concat(W?N().visible:""),children:[(0,n.jsx)("div",{className:N().sidebarHeader,children:(0,n.jsx)("h2",{children:"Chats"})}),(0,n.jsxs)("div",{className:N().searchContainer,children:[(0,n.jsx)(m.A,{size:18,className:N().searchIcon}),(0,n.jsx)("input",{type:"text",placeholder:"Search connections...",value:L,onChange:e=>O(e.target.value),className:N().searchInput})]}),(0,n.jsxs)("div",{className:N().connectionsList,children:[A&&0===l.length&&(0,n.jsx)("p",{className:N().listInfo,children:"Loading..."}),!A&&0===Y.length&&(0,n.jsx)("p",{className:N().listInfo,children:"No connections found."}),Y.map(e=>(0,n.jsxs)("div",{className:"".concat(N().connectionItem," ").concat((null==b?void 0:b._id)===e._id?N().active:""),onClick:()=>V(e),role:"button",tabIndex:0,"aria-label":"Chat with ".concat(e.name),children:[(0,n.jsxs)("div",{className:N().avatarContainer,children:[(0,n.jsx)("img",{src:e.avatar||"https://ui-avatars.com/api/?name=".concat(encodeURIComponent(e.name),"&background=random"),alt:"".concat(e.name,"'s avatar"),className:N().avatar}),e.isOnline&&(0,n.jsx)("div",{className:N().onlineIndicator})]}),(0,n.jsxs)("div",{className:N().connectionInfo,children:[(0,n.jsx)("h3",{children:e.name}),(0,n.jsx)("p",{className:N().lastMessage,children:e.lastMessage||"No messages yet"})]}),(0,n.jsxs)("div",{className:N().connectionMeta,children:[(0,n.jsx)("span",{className:N().lastMessageTime,children:I(e.lastMessageTimestamp)}),e.unreadCount>0&&(0,n.jsx)("span",{className:N().unreadBadge,children:e.unreadCount>9?"9+":e.unreadCount})]})]},e._id))]})]}),(0,n.jsx)("main",{className:"".concat(N().chatArea," ").concat(b?N().active:""),children:b?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("header",{className:N().chatHeader,children:[(0,n.jsxs)("div",{className:N().chatHeaderInfo,children:[(0,n.jsx)("button",{onClick:()=>{w(null),z(!0)},className:"".concat(N().iconButton," ").concat(N().backButton),children:(0,n.jsx)(u.A,{size:20})}),(0,n.jsxs)("div",{className:N().avatarContainer,children:[(0,n.jsx)("img",{src:b.avatar||"https://ui-avatars.com/api/?name=".concat(encodeURIComponent(b.name),"&background=random"),alt:"".concat(b.name,"'s avatar"),className:N().avatar}),b.isOnline&&(0,n.jsx)("div",{className:N().onlineIndicatorHeader})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h2",{children:b.name}),(0,n.jsxs)("p",{className:N().userStatus,children:[b.isOnline?"Online":"Last seen ".concat((0,d.B)(new Date(b.lastSeen||Date.now()-9e5))," ago")," ",(0,n.jsx)("span",{className:N().roleBadge,children:b.role||"Member"})]})]})]}),(0,n.jsx)("div",{className:N().chatHeaderActions,children:(0,n.jsx)("button",{className:N().iconButton,"aria-label":"More options",children:(0,n.jsx)(g.A,{size:20})})})]}),(0,n.jsxs)("div",{className:N().messagesContainer,children:[B&&(0,n.jsxs)("div",{className:N().loadingMessages,children:[(0,n.jsx)("div",{className:N().spinner}),(0,n.jsx)("p",{children:"Loading messages..."})]}),P&&!B&&(0,n.jsxs)("div",{className:N().errorContainerInline,children:[(0,n.jsxs)("p",{children:["Error loading messages: ",P]}),(0,n.jsx)("button",{className:N().retryButtonSmall,onClick:()=>G(b._id),children:"Retry"})]}),!B&&0===y.length&&!P&&(0,n.jsx)("div",{className:N().noMessages,children:"Start your conversation!"}),!B&&y.map((e,t)=>{var s,i;let r=0===t||new Date(y[t-1].createdAt).toDateString()!==new Date(e.createdAt).toDateString(),c=e.sender===(null==a?void 0:null===(s=a.user)||void 0===s?void 0:s.id);return(0,n.jsxs)("div",{children:[r&&(0,n.jsx)("div",{className:N().dateDivider,children:(0,n.jsx)("span",{children:(0,o.GP)(new Date(e.createdAt),"eeee, MMMM d")})}),(0,n.jsx)("div",{className:"".concat(N().messageWrapper," ").concat(c?N().sent:N().received),children:(0,n.jsxs)("div",{className:N().messageContent,children:[e.content,null===(i=e.attachments)||void 0===i?void 0:i.map((e,a)=>{var t;return(0,n.jsx)("div",{className:N().attachment,children:(null===(t=e.type)||void 0===t?void 0:t.startsWith("image"))?(0,n.jsx)("img",{src:e.url,alt:e.name||"Attachment",className:N().attachmentImage}):(0,n.jsxs)("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:N().attachmentLink,children:[(0,n.jsx)(v.A,{size:14}),(0,n.jsx)("span",{children:e.name||"Attached File"})]})},a)}),(0,n.jsxs)("div",{className:N().messageInfo,children:[(0,n.jsx)("span",{className:N().timestamp,children:f(e.createdAt)}),c&&K(e)]})]})})]},e._id||"msg-".concat(t))}),(0,n.jsx)("div",{ref:T})," "]}),(0,n.jsxs)("form",{className:N().inputContainer,onSubmit:U,children:[(0,n.jsx)("button",{type:"button",className:N().iconButton,onClick:()=>{var e;return null===(e=F.current)||void 0===e?void 0:e.click()},"aria-label":"Attach file",children:(0,n.jsx)(v.A,{size:22})}),(0,n.jsx)("input",{type:"file",ref:F,style:{display:"none"},onChange:e=>{console.log(e.target.files)},multiple:!0}),(0,n.jsx)("button",{type:"button",className:N().iconButton,"aria-label":"Insert emoji",children:(0,n.jsx)(C.A,{size:22})}),(0,n.jsx)("input",{type:"text",placeholder:"Type a message...",value:M,onChange:e=>H(e.target.value),className:N().messageInput,"aria-label":"Message input"}),(0,n.jsx)("button",{type:"submit",className:N().sendButton,disabled:!M.trim(),"aria-label":"Send message",children:(0,n.jsx)(p.A,{size:20})})]})]}):(0,n.jsxs)("div",{className:N().noChatSelected,children:[(0,n.jsx)(j.A,{size:64})," ",(0,n.jsxs)("h2",{children:["Welcome, ",(null==a?void 0:null===(e=a.user)||void 0===e?void 0:e.name)||"User","!"]}),(0,n.jsx)("p",{children:"Select a connection from the sidebar to start chatting."})]})})]})}},6633:(e,a,t)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/chat",function(){return t(2334)}])}},e=>{var a=a=>e(e.s=a);e.O(0,[0,655,636,593,792],()=>a(6633)),_N_E=e.O()}]);